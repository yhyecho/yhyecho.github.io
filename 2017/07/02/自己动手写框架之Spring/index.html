
 <!DOCTYPE HTML>
<html lang="java javascript">
<head>
  <meta charset="UTF-8">
  
    <title>自己动手写框架之Spring | echo home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="yhyecho">
    

    
    <meta name="description" content="为什么需要IOC 降低程序间的耦合性 让容器去管理Bean的生命周期 其实就是一个大工厂  自己实现架构图 代码实现pom.xml123456789101112131415161718192021222324252627282930313233343536&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&amp;lt;project xmlns=&quot;http://ma">
<meta property="og:type" content="article">
<meta property="og:title" content="自己动手写框架之Spring">
<meta property="og:url" content="http://www.yhyecho.com/2017/07/02/自己动手写框架之Spring/index.html">
<meta property="og:site_name" content="echo home">
<meta property="og:description" content="为什么需要IOC 降低程序间的耦合性 让容器去管理Bean的生命周期 其实就是一个大工厂  自己实现架构图 代码实现pom.xml123456789101112131415161718192021222324252627282930313233343536&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&amp;lt;project xmlns=&quot;http://ma">
<meta property="og:locale" content="java javascript">
<meta property="og:image" content="http://www.yhyecho.com/2017/07/02/img/spring_ioc.png">
<meta property="og:image" content="http://www.yhyecho.com/2017/07/02/img/reflect.png">
<meta property="og:updated_time" content="2018-02-05T09:27:14.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="自己动手写框架之Spring">
<meta name="twitter:description" content="为什么需要IOC 降低程序间的耦合性 让容器去管理Bean的生命周期 其实就是一个大工厂  自己实现架构图 代码实现pom.xml123456789101112131415161718192021222324252627282930313233343536&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&amp;lt;project xmlns=&quot;http://ma">
<meta name="twitter:image" content="http://www.yhyecho.com/2017/07/02/img/spring_ioc.png">

    
    
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="echo home">echo home</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:www.yhyecho.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/07/02/自己动手写框架之Spring/" title="自己动手写框架之Spring" itemprop="url">自己动手写框架之Spring</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="yhyecho" target="_blank" itemprop="author">yhyecho</a>
		
  <p class="article-time">
    <time datetime="2017-07-02T15:12:33.000Z" itemprop="datePublished"> Published 2017-07-02</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么需要IOC"><span class="toc-number">1.</span> <span class="toc-text">为什么需要IOC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自己实现架构图"><span class="toc-number">2.</span> <span class="toc-text">自己实现架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码实现"><span class="toc-number">3.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pom-xml"><span class="toc-number">3.0.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#applicationContext-xml"><span class="toc-number">3.0.2.</span> <span class="toc-text">applicationContext.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#存在引用关系的Bean"><span class="toc-number">3.0.3.</span> <span class="toc-text">存在引用关系的Bean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#对配置文件种Bean的封装"><span class="toc-number">3.0.4.</span> <span class="toc-text">对配置文件种Bean的封装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置文件解析器"><span class="toc-number">3.0.5.</span> <span class="toc-text">配置文件解析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取Bean的工具类"><span class="toc-number">3.0.6.</span> <span class="toc-text">获取Bean的工具类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#构建全局对象工厂"><span class="toc-number">3.0.7.</span> <span class="toc-text">构建全局对象工厂</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#单元测试"><span class="toc-number">3.0.8.</span> <span class="toc-text">单元测试</span></a></li></ol></li></ol></li></ol>
		
		</div>
		
		<h2 id="为什么需要IOC"><a href="#为什么需要IOC" class="headerlink" title="为什么需要IOC"></a>为什么需要IOC</h2><ul>
<li>降低程序间的耦合性</li>
<li>让容器去管理Bean的生命周期</li>
<li>其实就是一个大工厂</li>
</ul>
<h2 id="自己实现架构图"><a href="#自己实现架构图" class="headerlink" title="自己实现架构图"></a>自己实现架构图</h2><p><img src="../img/spring_ioc.png" alt=""><br><img src="../img/reflect.png" alt=""></p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h4 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></div><div class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ThreeFramework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yhyecho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>MySpring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dom4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dom4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jaxen<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxen<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="applicationContext-xml"><a href="#applicationContext-xml" class="headerlink" title="applicationContext.xml"></a>applicationContext.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 将A配置到配置文件中 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"A"</span> <span class="attr">class</span>=<span class="string">"com.yhyecho.bean.A"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 将A的属性配置, spring会自动将配置的值注入到A中 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"yhyecho"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"age"</span> <span class="attr">value</span>=<span class="string">"18"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"B"</span> <span class="attr">class</span>=<span class="string">"com.yhyecho.bean.B"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- ref表示要将Bean A 注入 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"a"</span> <span class="attr">ref</span>=<span class="string">"A"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"C"</span> <span class="attr">class</span>=<span class="string">"com.yhyecho.bean.C"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- ref表示要将Bean B 注入 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"b"</span> <span class="attr">ref</span>=<span class="string">"B"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="存在引用关系的Bean"><a href="#存在引用关系的Bean" class="headerlink" title="存在引用关系的Bean"></a>存在引用关系的Bean</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.bean;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"A对象被创建了!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age; <span class="comment">// 测试int类型的值注入(是否支持自动类型转换!)</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> age;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.age = age;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.bean;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"B对象被创建了!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> A a;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> A <span class="title">getA</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> a;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span><span class="params">(A a)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.a = a;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.bean;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">C</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"C对象被创建了!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> B b;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> B <span class="title">getB</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> b;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setB</span><span class="params">(B b)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.b = b;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="对配置文件种Bean的封装"><a href="#对配置文件种Bean的封装" class="headerlink" title="对配置文件种Bean的封装"></a>对配置文件种Bean的封装</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.config;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String className;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String scope = <span class="string">"singleton"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;Property&gt; properties = <span class="keyword">new</span> ArrayList&lt;Property&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getClassName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> className;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClassName</span><span class="params">(String className)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.className = className;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;Property&gt; <span class="title">getProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> properties;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(List&lt;Property&gt; properties)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.properties = properties;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getScope</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> scope;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setScope</span><span class="params">(String scope)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.scope = scope;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.config;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Property</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String value;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String ref;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getValue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(String value)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.value = value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRef</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> ref;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRef</span><span class="params">(String ref)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.ref = ref;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="配置文件解析器"><a href="#配置文件解析器" class="headerlink" title="配置文件解析器"></a>配置文件解析器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.config.parse;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.yhyecho.config.Bean;</div><div class="line"><span class="keyword">import</span> com.yhyecho.config.Property;</div><div class="line"><span class="keyword">import</span> org.dom4j.Document;</div><div class="line"><span class="keyword">import</span> org.dom4j.DocumentException;</div><div class="line"><span class="keyword">import</span> org.dom4j.Element;</div><div class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 读取配置文件 =&gt; 并返回读取结果</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Bean&gt; <span class="title">getConfig</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">        <span class="comment">// 创建一个用于返回的map对象</span></div><div class="line">        Map&lt;String, Bean&gt; map = <span class="keyword">new</span> HashMap&lt;String, Bean&gt;();</div><div class="line"></div><div class="line">        <span class="comment">// dom4j实现</span></div><div class="line">        <span class="comment">// 1. 创建解析器</span></div><div class="line">        SAXReader reader = <span class="keyword">new</span> SAXReader();</div><div class="line">        <span class="comment">// 2. 加载配置文件 =&gt; document对象</span></div><div class="line">        InputStream is = ConfigManager.class.getResourceAsStream(path);</div><div class="line">        Document doc = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            doc = reader.read(is);</div><div class="line">        &#125; <span class="keyword">catch</span> (DocumentException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"请检查您的xml配置是否正确"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 3. 定义xpath表达式, 取出所有Bean元素</span></div><div class="line">        String xpath = <span class="string">"//bean"</span>;</div><div class="line">        <span class="comment">// 4. 对Bean 元素进行遍历</span></div><div class="line">        List&lt;Element&gt; list = doc.selectNodes(xpath);</div><div class="line">        <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (Element beanItem : list) &#123;</div><div class="line">                <span class="comment">// 4.1 将bean元素的name/class 属性封装到Bean对象中</span></div><div class="line">                Bean bean = <span class="keyword">new</span> Bean();</div><div class="line">                String name = beanItem.attributeValue(<span class="string">"name"</span>);</div><div class="line">                String className = beanItem.attributeValue(<span class="string">"class"</span>);</div><div class="line">                String scope = beanItem.attributeValue(<span class="string">"scope"</span>);</div><div class="line"></div><div class="line">                bean.setName(name);</div><div class="line">                bean.setClassName(className);</div><div class="line">                <span class="keyword">if</span> (scope != <span class="keyword">null</span>) &#123;</div><div class="line">                    bean.setScope(scope);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 4.2 获得Bean元素下的所有Property子元素, 将属性(name/value/ref)封装到Property对象中</span></div><div class="line">                List&lt;Element&gt; children = beanItem.elements(<span class="string">"property"</span>);</div><div class="line">                <span class="keyword">if</span> (children != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">for</span> (Element child : children) &#123;</div><div class="line">                        Property prop = <span class="keyword">new</span> Property();</div><div class="line">                        String pName = child.attributeValue(<span class="string">"name"</span>);</div><div class="line">                        String pValue = child.attributeValue(<span class="string">"value"</span>);</div><div class="line">                        String pRef = child.attributeValue(<span class="string">"ref"</span>);</div><div class="line"></div><div class="line">                        prop.setName(pName);</div><div class="line">                        prop.setRef(pRef);</div><div class="line">                        prop.setValue(pValue);</div><div class="line">                        <span class="comment">// 4.3 将Property封装到Bean对象</span></div><div class="line">                        bean.getProperties().add(prop);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 4.4 将Bean对象封装到Map中(用于返回的map)</span></div><div class="line">                map.put(name, bean);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 5. 返回Map结果</span></div><div class="line">        <span class="keyword">return</span> map;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="获取Bean的工具类"><a href="#获取Bean的工具类" class="headerlink" title="获取Bean的工具类"></a>获取Bean的工具类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.utils;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.beans.BeanInfo;</div><div class="line"><span class="keyword">import</span> java.beans.IntrospectionException;</div><div class="line"><span class="keyword">import</span> java.beans.Introspector;</div><div class="line"><span class="keyword">import</span> java.beans.PropertyDescriptor;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 内省: 基于反射技术, 用于操作Bean属性的一套API</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanUtils</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 参数1 bean对象</span></div><div class="line">    <span class="comment">// 参数2 要获得的Bean对象对应的属性名称</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Method <span class="title">getWriteMethod</span><span class="params">(Object beanObj, String name)</span> </span>&#123;</div><div class="line"></div><div class="line">        Method writeMethod = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="comment">// 使用内省技术来实现该方法</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 1. 分析Bean对象 =&gt; BeanInfo</span></div><div class="line">            BeanInfo beanInfo = Introspector.getBeanInfo(beanObj.getClass());</div><div class="line">            <span class="comment">// 2. 根据BeanInfo获得所有属性的描述器</span></div><div class="line">            PropertyDescriptor[] propertyDescriptors = beanInfo.getPropertyDescriptors();</div><div class="line">            <span class="comment">// 3. 遍历这些属性描述器</span></div><div class="line">            <span class="keyword">if</span> (propertyDescriptors != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (PropertyDescriptor item : propertyDescriptors) &#123;</div><div class="line">                    <span class="comment">// 判断当前遍历的描述器是否是我们要找的属性</span></div><div class="line">                    <span class="comment">// 获得当前描述器描述的属性名称</span></div><div class="line">                    String pName = item.getName();</div><div class="line">                    <span class="comment">// 使用要找的属性名称与当前描述器描述的属性名称比对</span></div><div class="line">                    <span class="keyword">if</span> (pName.equals(name)) &#123;</div><div class="line">                        <span class="comment">// 比对一致 =&gt; 找到了 =&gt; 获取写入属性的set方法</span></div><div class="line">                        <span class="comment">// 4. 返回找到的set方法</span></div><div class="line">                        writeMethod = item.getWriteMethod();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IntrospectionException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 如果没有找到 =&gt; 抛出异常提示用户检查是否创建属性对应的set方法</span></div><div class="line">        <span class="keyword">if</span> (writeMethod == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"客观, 请检查"</span> + name + <span class="string">"属性的set方法是否创建!"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> writeMethod;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="构建全局对象工厂"><a href="#构建全局对象工厂" class="headerlink" title="构建全局对象工厂"></a>构建全局对象工厂</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.main;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 根据Bean的name获得Bean对象的方法</span></div><div class="line">    <span class="function">Object <span class="title">getBean</span><span class="params">(String beanName)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.main;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.yhyecho.config.Bean;</div><div class="line"><span class="keyword">import</span> com.yhyecho.config.Property;</div><div class="line"><span class="keyword">import</span> com.yhyecho.config.parse.ConfigManager;</div><div class="line"><span class="keyword">import</span> com.yhyecho.utils.BeanUtils;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassPathXmlApplicationContext</span> <span class="keyword">implements</span> <span class="title">BeanFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 配置信息</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, Bean&gt; config;</div><div class="line"></div><div class="line">    <span class="comment">// 使用一个map来做spring的容器 =&gt; 放置我们spring所管理的对象</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; context = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line"></div><div class="line">    <span class="comment">// 希望在ClassPathXmlApplicationContext类一创建时, 就初始化spring容器(装载Bean实例的)</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassPathXmlApplicationContext</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">        <span class="comment">// 1. 读取配置文件获取需要初始化的Bean信息</span></div><div class="line">        config = ConfigManager.getConfig(path);</div><div class="line">        <span class="comment">// 2. 遍历配置 初始化Bean</span></div><div class="line">        <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Bean&gt; en : config.entrySet()) &#123;</div><div class="line">                <span class="comment">// 获取配置中的Bean信息</span></div><div class="line">                String beanName = en.getKey();</div><div class="line">                Bean bean = en.getValue();</div><div class="line"></div><div class="line">                <span class="comment">// 因为createBean方法中也会向Context中放置Bean</span></div><div class="line">                <span class="comment">// 为了避免重复放入, 先做个判断</span></div><div class="line">                <span class="comment">// 容器中不存在 并且Bean的scope属性值为singleton,才将Bean放入容器中.</span></div><div class="line">                Object existBean = context.get(beanName);</div><div class="line">                <span class="keyword">if</span> (existBean == <span class="keyword">null</span> &amp;&amp; bean.getScope().equals(<span class="string">"singleton"</span>)) &#123;</div><div class="line">                    <span class="comment">// 根据bean配置, 创建bean对象</span></div><div class="line">                    Object beanObj = createBean(bean);</div><div class="line">                    <span class="comment">// 3. 将初始化好的Bean放入容器中</span></div><div class="line">                    context.put(beanName, beanObj);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 根据Bean配置创建Bean实例</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &lt;bean name="A" class="com.yhyecho.bean.A"&gt;</span></div><div class="line"><span class="comment">     * &lt;property name="name" value="Tom"&gt;&lt;/property&gt;</span></div><div class="line"><span class="comment">     * &lt;/bean&gt;</span></div><div class="line"><span class="comment">     **/</span></div><div class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">createBean</span><span class="params">(Bean bean)</span> </span>&#123;</div><div class="line">        <span class="comment">// 1. 获取要创建的Bean的Class</span></div><div class="line">        String className = bean.getClassName();</div><div class="line">        Class clazz = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            clazz = Class.forName(className);</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"客官, 请检查您Bean的Class配置是否正确!"</span> + className);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 获取class =&gt; 将class对应的对象创建出来</span></div><div class="line">        Object beanObj = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            beanObj = clazz.newInstance(); <span class="comment">// 调用空参构造</span></div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"客官, 您的Bean没有无参构造方法"</span> + className);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 2. 需要获取Bean的属性, 将其注入</span></div><div class="line">        <span class="keyword">if</span> (bean.getProperties() != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (Property prop : bean.getProperties()) &#123;</div><div class="line"></div><div class="line">                <span class="comment">// 获取要注入的属性名称</span></div><div class="line">                String name = prop.getName();</div><div class="line"></div><div class="line">                <span class="comment">// 注入属性方式2: 使用BeanUtils工具类完成属性的注入</span></div><div class="line">                String value = prop.getValue();</div><div class="line">                String ref = prop.getRef();</div><div class="line"></div><div class="line">                <span class="comment">// 用于注入值类型的属性</span></div><div class="line">                <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123; <span class="comment">// 说明有值类型的属性需要注入</span></div><div class="line">                    Map&lt;String, String[]&gt; paramMap = <span class="keyword">new</span> HashMap&lt;String, String[]&gt;();</div><div class="line">                    paramMap.put(name, <span class="keyword">new</span> String[]&#123;value&#125;);</div><div class="line">                    <span class="comment">// 调用BeanUtils方法将值类型的属性注入(该种注入 =&gt; 可以自动完成类型转换)</span></div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        org.apache.commons.beanutils.BeanUtils.populate(beanObj, paramMap);</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"客官! 请检查您的"</span> + name + <span class="string">"属性!"</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 用于注入Bean类型的属性</span></div><div class="line">                <span class="keyword">if</span> (prop.getRef() != <span class="keyword">null</span>) &#123;</div><div class="line">                    Method setMethod = BeanUtils.getWriteMethod(beanObj, name);</div><div class="line">                    <span class="comment">// 因为要注入其他Bean到当前bean中, 我们先从容器中查找当前要注入的Bean是否已经创建,并注入到容器中.</span></div><div class="line">                    Object existBean = context.get(prop.getRef());</div><div class="line">                    <span class="keyword">if</span> (existBean == <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">// 说明容器中还不存在我们要注入的Bean</span></div><div class="line">                        <span class="comment">// 将Bean创建[递归调用]</span></div><div class="line">                        existBean = createBean(config.get(prop.getRef()));</div><div class="line">                        <span class="comment">// 将创建好的Bean放入容器中</span></div><div class="line">                        <span class="keyword">if</span> (config.get(prop.getRef()).getScope().equals(<span class="string">"singleton"</span>)) &#123;</div><div class="line">                            context.put(prop.getRef(), existBean);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//调用set方法注入即可</span></div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        setMethod.invoke(beanObj, existBean);</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"客官, 您的Bean的属性 "</span> + name + <span class="string">" 没有对应的set方法"</span> + className);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">/*</span></div><div class="line"><span class="comment">                    // 根据属性名称获得注入属性对应的Set方法</span></div><div class="line"><span class="comment">                    Method setMethod = BeanUtils.getWriteMethod(beanObj, name);</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">                    // 注入分两种情况</span></div><div class="line"><span class="comment">                    // 创建一个需要注入到Bean中的属性</span></div><div class="line"><span class="comment">                    Object param = null;</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">                    // 2.1 简单 =&gt; value属性注入</span></div><div class="line"><span class="comment">                    if (prop.getValue() != null) &#123;</span></div><div class="line"><span class="comment">                        // 获取要注入的属性值</span></div><div class="line"><span class="comment">                        String value = prop.getValue();</span></div><div class="line"><span class="comment">                        param = value;</span></div><div class="line"><span class="comment">                    &#125;</span></div><div class="line"><span class="comment">                    // 2.2 麻烦 =&gt; 其他Bean的注入</span></div><div class="line"><span class="comment">                    if (prop.getRef() != null) &#123;</span></div><div class="line"><span class="comment">                        // 因为要注入其他Bean到当前bean中, 我们先从容器中查找当前要注入的Bean是否已经创建,并注入到容器中.</span></div><div class="line"><span class="comment">                        Object existBean = context.get(prop.getRef());</span></div><div class="line"><span class="comment">                        if (existBean == null) &#123;</span></div><div class="line"><span class="comment">                            // 说明容器中还不存在我们要注入的Bean</span></div><div class="line"><span class="comment">                            // 将Bean创建[递归调用]</span></div><div class="line"><span class="comment">                            existBean = createBean(config.get(prop.getRef()));</span></div><div class="line"><span class="comment">                            // 将创建好的Bean放入容器中</span></div><div class="line"><span class="comment">                            if (config.get(prop.getRef()).getScope().equals("singleton")) &#123;</span></div><div class="line"><span class="comment">                                context.put(prop.getRef(), existBean);</span></div><div class="line"><span class="comment">                            &#125;</span></div><div class="line"><span class="comment">                        &#125;</span></div><div class="line"><span class="comment">                        param = existBean;</span></div><div class="line"><span class="comment">                    &#125;</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">                    //调用set方法注入即可</span></div><div class="line"><span class="comment">                    try &#123;</span></div><div class="line"><span class="comment">                        setMethod.invoke(beanObj, param);</span></div><div class="line"><span class="comment">                    &#125; catch (Exception e) &#123;</span></div><div class="line"><span class="comment">                        e.printStackTrace();</span></div><div class="line"><span class="comment">                        throw new RuntimeException("客官, 您的Bean的属性 " + name + " 没有对应的set方法" + className);</span></div><div class="line"><span class="comment">                    &#125;</span></div><div class="line"><span class="comment">                */</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> beanObj;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 根据Bean的名称获得Bean实例</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String beanName)</span> </span>&#123;</div><div class="line"></div><div class="line">        Object bean = context.get(beanName);</div><div class="line">        <span class="comment">// 如果bean的scope配置为prototype, 那么context中就不会包含该Bean对象</span></div><div class="line">        <span class="keyword">if</span> (bean == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 如果不存在该Bean对象, 那么就创建这个Bean对象</span></div><div class="line">            bean = createBean(config.get(beanName));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> bean;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.yhyecho.bean.A;</div><div class="line"><span class="keyword">import</span> com.yhyecho.bean.B;</div><div class="line"><span class="keyword">import</span> com.yhyecho.bean.C;</div><div class="line"><span class="keyword">import</span> com.yhyecho.config.Bean;</div><div class="line"><span class="keyword">import</span> com.yhyecho.config.parse.ConfigManager;</div><div class="line"><span class="keyword">import</span> com.yhyecho.main.BeanFactory;</div><div class="line"><span class="keyword">import</span> com.yhyecho.main.ClassPathXmlApplicationContext;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test01</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 测试读取配置文件的ConfigManager.java是否正确</span></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</div><div class="line">        Map&lt;String, Bean&gt; config = ConfigManager.getConfig(<span class="string">"/applicationContext.xml"</span>);</div><div class="line"></div><div class="line">        System.out.println(config);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// 测试值注入</span></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span> </span>&#123;</div><div class="line">        BeanFactory bf = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"/applicationContext.xml"</span>);</div><div class="line">        <span class="comment">//值注入</span></div><div class="line">        A a = (A) bf.getBean(<span class="string">"A"</span>);</div><div class="line">        System.out.println(a.getName()); <span class="comment">// yhyecho</span></div><div class="line">        System.out.println(a.getAge()); <span class="comment">// 18</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 引用类型注入</span></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test03</span><span class="params">()</span> </span>&#123;</div><div class="line">        BeanFactory bf = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"/applicationContext.xml"</span>);</div><div class="line"></div><div class="line">        B b = (B) bf.getBean(<span class="string">"B"</span>);</div><div class="line">        System.out.println(b.getA().getName()); <span class="comment">// yhyecho</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 获取C的Bean</span></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test04</span><span class="params">()</span> </span>&#123;</div><div class="line">        BeanFactory bf = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"/applicationContext.xml"</span>);</div><div class="line"></div><div class="line">        C c = (C) bf.getBean(<span class="string">"C"</span>);</div><div class="line">        System.out.println(c.getB().getA().getName()); <span class="comment">// yhyecho</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 测试scope配置</span></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test05</span><span class="params">()</span> </span>&#123;</div><div class="line">        BeanFactory bf = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"/applicationContext.xml"</span>);</div><div class="line">        <span class="comment">//A只有在容器初始化的时候被创建!</span></div><div class="line">        A a = (A) bf.getBean(<span class="string">"A"</span>);</div><div class="line">        A a2 = (A) bf.getBean(<span class="string">"A"</span>);</div><div class="line">        A a3 = (A) bf.getBean(<span class="string">"A"</span>);</div><div class="line"></div><div class="line"></div><div class="line">        System.out.println(<span class="string">"=========测试scope为prototype和singleton========="</span>);</div><div class="line">        <span class="comment">// B被实例化了3次</span></div><div class="line">        B b = (B) bf.getBean(<span class="string">"B"</span>);</div><div class="line">        B b1 = (B) bf.getBean(<span class="string">"B"</span>);</div><div class="line">        B b2 = (B) bf.getBean(<span class="string">"B"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://www.yhyecho.com/2017/07/02/自己动手写框架之Spring/" data-title="自己动手写框架之Spring | echo home" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/10/03/React入门/" title="React入门">
  <strong>上一篇：</strong><br/>
  <span>
  React入门</span>
</a>
</div>


<div class="next">
<a href="/2017/06/10/自己动手写框架之Struts2/"  title="自己动手写框架之Struts2">
 <strong>下一篇：</strong><br/> 
 <span>自己动手写框架之Struts2
</span>
</a>
</div>

</nav>

	


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么需要IOC"><span class="toc-number">1.</span> <span class="toc-text">为什么需要IOC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自己实现架构图"><span class="toc-number">2.</span> <span class="toc-text">自己实现架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码实现"><span class="toc-number">3.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pom-xml"><span class="toc-number">3.0.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#applicationContext-xml"><span class="toc-number">3.0.2.</span> <span class="toc-text">applicationContext.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#存在引用关系的Bean"><span class="toc-number">3.0.3.</span> <span class="toc-text">存在引用关系的Bean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#对配置文件种Bean的封装"><span class="toc-number">3.0.4.</span> <span class="toc-text">对配置文件种Bean的封装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置文件解析器"><span class="toc-number">3.0.5.</span> <span class="toc-text">配置文件解析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取Bean的工具类"><span class="toc-number">3.0.6.</span> <span class="toc-text">获取Bean的工具类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#构建全局对象工厂"><span class="toc-number">3.0.7.</span> <span class="toc-text">构建全局对象工厂</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#单元测试"><span class="toc-number">3.0.8.</span> <span class="toc-text">单元测试</span></a></li></ol></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github Card</p>
<div class="github-card" data-github="yhyecho" data-theme="medium"></div>
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>



</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<section class="info">
		<p> Hello, I&#39;m Echo  <br/>
			This is my blog, Welcome</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/yhyecho" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="yhyecho">yhyecho</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
