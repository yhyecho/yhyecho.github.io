
 <!DOCTYPE HTML>
<html lang="java javascript">
<head>
  <meta charset="UTF-8">
  
    <title>Java常用消息中间件入门 | echo home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="yhyecho">
    

    
    <meta name="description" content="为什么需要消息中间件 未用消息中间件时的服务调用 使用用消息中间件进行服务调用消息中间件的作用 解耦 异步 横向扩展 安全可靠 顺序保证什么是中间件 非底层操作系统软件, 非业务应用软件,不是直接给最终用户使用的,不能直接给客户带来价值的软件统称为中间件. 什么是消息中间件关注于数据的发送和接收, 利用高效可靠的异步消息传递机制集成分布式系统. 什么是JMSJava消息服务(Java Messag">
<meta property="og:type" content="article">
<meta property="og:title" content="Java常用消息中间件入门">
<meta property="og:url" content="http://www.yhyecho.com/2017/12/09/Java常用消息中间件入门/index.html">
<meta property="og:site_name" content="echo home">
<meta property="og:description" content="为什么需要消息中间件 未用消息中间件时的服务调用 使用用消息中间件进行服务调用消息中间件的作用 解耦 异步 横向扩展 安全可靠 顺序保证什么是中间件 非底层操作系统软件, 非业务应用软件,不是直接给最终用户使用的,不能直接给客户带来价值的软件统称为中间件. 什么是消息中间件关注于数据的发送和接收, 利用高效可靠的异步消息传递机制集成分布式系统. 什么是JMSJava消息服务(Java Messag">
<meta property="og:locale" content="java javascript">
<meta property="og:image" content="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/mq1.png">
<meta property="og:image" content="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/mq2.png">
<meta property="og:image" content="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/quene.png">
<meta property="og:image" content="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/topic.png">
<meta property="og:image" content="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/jms.png">
<meta property="og:image" content="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/broker.png">
<meta property="og:updated_time" content="2018-03-21T03:05:24.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java常用消息中间件入门">
<meta name="twitter:description" content="为什么需要消息中间件 未用消息中间件时的服务调用 使用用消息中间件进行服务调用消息中间件的作用 解耦 异步 横向扩展 安全可靠 顺序保证什么是中间件 非底层操作系统软件, 非业务应用软件,不是直接给最终用户使用的,不能直接给客户带来价值的软件统称为中间件. 什么是消息中间件关注于数据的发送和接收, 利用高效可靠的异步消息传递机制集成分布式系统. 什么是JMSJava消息服务(Java Messag">
<meta name="twitter:image" content="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/mq1.png">

    
    
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="echo home">echo home</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:www.yhyecho.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/12/09/Java常用消息中间件入门/" title="Java常用消息中间件入门" itemprop="url">Java常用消息中间件入门</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="yhyecho" target="_blank" itemprop="author">yhyecho</a>
		
  <p class="article-time">
    <time datetime="2017-12-09T11:07:02.000Z" itemprop="datePublished"> 发表于 2017-12-09</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么需要消息中间件"><span class="toc-number">1.</span> <span class="toc-text">为什么需要消息中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息中间件的作用"><span class="toc-number">2.</span> <span class="toc-text">消息中间件的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是中间件"><span class="toc-number">3.</span> <span class="toc-text">什么是中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是消息中间件"><span class="toc-number">4.</span> <span class="toc-text">什么是消息中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是JMS"><span class="toc-number">5.</span> <span class="toc-text">什么是JMS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是AMQP"><span class="toc-number">6.</span> <span class="toc-text">什么是AMQP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JMS和AMQP对比"><span class="toc-number">7.</span> <span class="toc-text">JMS和AMQP对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用消息中间件对比"><span class="toc-number">8.</span> <span class="toc-text">常用消息中间件对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#综合比较"><span class="toc-number">9.</span> <span class="toc-text">综合比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JMS规范"><span class="toc-number">10.</span> <span class="toc-text">JMS规范</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#队列模型"><span class="toc-number">10.1.</span> <span class="toc-text">队列模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#主题模式"><span class="toc-number">10.2.</span> <span class="toc-text">主题模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JMS编码接口"><span class="toc-number">10.3.</span> <span class="toc-text">JMS编码接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ActiveMQ-的安装与使用"><span class="toc-number">11.</span> <span class="toc-text">ActiveMQ 的安装与使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#本地java版本必须要1-8及以上"><span class="toc-number">12.</span> <span class="toc-text">本地java版本必须要1.8及以上</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用Spring集成JMS连接ActiveMQ"><span class="toc-number">13.</span> <span class="toc-text">使用Spring集成JMS连接ActiveMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息中间件-集群环境"><span class="toc-number">14.</span> <span class="toc-text">消息中间件(集群环境)</span></a></li></ol>
		
		</div>
		
		<h3 id="为什么需要消息中间件"><a href="#为什么需要消息中间件" class="headerlink" title="为什么需要消息中间件"></a>为什么需要消息中间件</h3><ul>
<li>未用消息中间件时的服务调用<br><img src="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/mq1.png" alt=""></li>
<li>使用用消息中间件进行服务调用<br><img src="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/mq2.png" alt=""><h3 id="消息中间件的作用"><a href="#消息中间件的作用" class="headerlink" title="消息中间件的作用"></a>消息中间件的作用</h3></li>
<li>解耦</li>
<li>异步</li>
<li>横向扩展</li>
<li>安全可靠</li>
<li>顺序保证<h3 id="什么是中间件"><a href="#什么是中间件" class="headerlink" title="什么是中间件"></a>什么是中间件</h3><blockquote>
<p>非底层操作系统软件, 非业务应用软件,不是直接给最终用户使用的,不能直接给客户带来价值的软件统称为中间件.</p>
<h3 id="什么是消息中间件"><a href="#什么是消息中间件" class="headerlink" title="什么是消息中间件"></a>什么是消息中间件</h3><p>关注于数据的发送和接收, 利用高效可靠的异步消息传递机制集成分布式系统.</p>
<h3 id="什么是JMS"><a href="#什么是JMS" class="headerlink" title="什么是JMS"></a>什么是JMS</h3><p>Java消息服务(Java Message Service)即JMS,是一个Java平台中关于面向消息中间件的API, 用于在两个应用程序之间，或分布式系统中发送消息, 进行异步通信.</p>
<h3 id="什么是AMQP"><a href="#什么是AMQP" class="headerlink" title="什么是AMQP"></a>什么是AMQP</h3><p>AMQP(advanced message queuing protocol)是一个提供统一消息服务的应用层的标准协议, 基于此协议的客户端与消息中间件可传递消息, 并不受客户端/中间件不同产品,不同开发语言等条件的限制.</p>
</blockquote>
</li>
</ul>
<h3 id="JMS和AMQP对比"><a href="#JMS和AMQP对比" class="headerlink" title="JMS和AMQP对比"></a>JMS和AMQP对比</h3><table>
<thead>
<tr>
<th>维度</th>
<th style="text-align:center">JMS规范</th>
<th style="text-align:center">AMQP协议</th>
</tr>
</thead>
<tbody>
<tr>
<td>定义</td>
<td style="text-align:center">Java api</td>
<td style="text-align:center">Wire-protocol </td>
</tr>
<tr>
<td>跨语言</td>
<td style="text-align:center">否</td>
<td style="text-align:center">是 </td>
</tr>
<tr>
<td>消息模型</td>
<td style="text-align:center">提供两种消息模型: p2p, pub/sub</td>
<td style="text-align:center">提供五种消息模型: direct,fanout,topic,headers,system</td>
</tr>
<tr>
<td>消息类型</td>
<td style="text-align:center">TextMessage,MapMessage,BytesMessage,StreamMessage,ObjectMessage,Message</td>
<td style="text-align:center">byte[]</td>
</tr>
<tr>
<td>综合评价</td>
<td style="text-align:center">JMS定义了JAVA API层面的标准, 在java体系中,多个client均可以通过JMS进行交互,不需要应用修改代码, 但是其对跨平台的支持较差</td>
<td style="text-align:center">AMQP的主要特征是面向消息、队列、路由(包括点对点的发布/订阅) 可靠性,安全性高.</td>
</tr>
</tbody>
</table>
<h3 id="常用消息中间件对比"><a href="#常用消息中间件对比" class="headerlink" title="常用消息中间件对比"></a>常用消息中间件对比</h3><ol>
<li>ActiveMQ<blockquote>
<p>ActiveMQ是Apache出品，最流行的，能力强劲的开源消息总线。ActiveMQ是一个完全支持JMS1.1和J2EE1.4规范的JMS<br>Provider实现，尽管JMS规范很早便出台，但是JMS在当今的J2EE应用中仍然拥有着特殊的地位</p>
</blockquote>
</li>
</ol>
<blockquote>
<p>特性: </p>
<ul>
<li>多种语言和协议编写客户端，语言: Java,C,C++,C#,Ruby,Perl,Python,PHP. 应用协议: OpenWire,Stomp REST, WS NOtification, XMPP, AMQP</li>
<li>完全支持JMS1.1和J2EE1.4规范(持久化, XA消息, 事务)</li>
<li>虚拟主题、组合目的、镜像队列</li>
</ul>
</blockquote>
<ol>
<li>RabbitMQ<blockquote>
<p>RabbitMQ是一个开源的AMQP实现, 服务器端用Erlang语言编写.用于在分布式系统中存储转发消息, 在易用性、扩展性、高可用性等方面表现不俗.</p>
</blockquote>
</li>
</ol>
<blockquote>
<p>特性: </p>
<ul>
<li>支持多种客户端, 如: Python、Ruby、.NEt、Java、JMS、C、PHP、ActionScript等</li>
<li>AMQP的完整实现(vhost、Exchange、Binding、Routing Key等)</li>
<li>事务支持/发布确认</li>
<li>消息持久化</li>
</ul>
</blockquote>
<ol>
<li>Kafka<blockquote>
<p>Kafka是一个高吞吐量的分布式发布订阅消息系统, 是一个分布式的、分区的、可靠的分布式日志存储服务.它通过一种独一无二的设计提供了一个消息系统的功能.</p>
</blockquote>
</li>
</ol>
<blockquote>
<p>特性: </p>
<ul>
<li>通过O(1)的磁盘数据结构提供消息的持久化, 这种结构对于即使数以TB的消息存储也能够保持长时间的稳定性能</li>
<li>高吞吐量: 即使是非常普通的硬件Kafka也可以支持每秒数百万的消息</li>
<li>Partition、Consumer Group</li>
</ul>
</blockquote>
<h3 id="综合比较"><a href="#综合比较" class="headerlink" title="综合比较"></a>综合比较</h3><table>
<thead>
<tr>
<th>维度</th>
<th style="text-align:center">ActiveMQ</th>
<th style="text-align:center">RabbitMQ</th>
<th style="text-align:center">Kafka </th>
</tr>
</thead>
<tbody>
<tr>
<td>跨语言</td>
<td style="text-align:center">支持(Java优先)</td>
<td style="text-align:center">语言无关</td>
<td style="text-align:center">支持(Java优先) </td>
</tr>
<tr>
<td>支持协议</td>
<td style="text-align:center">OpenWire, Stomp, XMPP, AMQP</td>
<td style="text-align:center">AMQP</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>优点</td>
<td style="text-align:center">遵循JMS规范, 安装部署方便</td>
<td style="text-align:center">继承Erlang天生的并发性, 最初用于金融行业,稳定性,安全性有保障</td>
<td style="text-align:center">依赖zk,可动态扩展节点, 高性能、高吞吐量、无限扩容、消息可指定追溯 </td>
</tr>
<tr>
<td>缺点</td>
<td style="text-align:center">根据其他用户反馈,会莫名丢失消息. 目前重心在下代产品apolle上,目前社区不活跃,对5.X维护较少</td>
<td style="text-align:center">Erlang语言难度较大, 不支持动态扩展</td>
<td style="text-align:center">严格的顺序机制, 不支持消息优先级, 不支持标准的消息协议, 不利于平台迁移 </td>
</tr>
<tr>
<td>综合评价</td>
<td style="text-align:center">适合中小企业级消息应用场景，不适合上千个队列的应用场景</td>
<td style="text-align:center">适合对稳定性要求高的企业级应用</td>
<td style="text-align:center">一般应用在大数据日志处理或对实时性(少量延迟)，可靠性(少量丢数据)要求稍低的场景使用 </td>
</tr>
</tbody>
</table>
<h3 id="JMS规范"><a href="#JMS规范" class="headerlink" title="JMS规范"></a>JMS规范</h3><ul>
<li>提供者: 实现JMS规范的消息中间件服务器</li>
<li>客户端: 发送或接收消息的应用程序</li>
<li>生产者/发布者: 创建并发送消息的客户端</li>
<li>消费者/订阅者: 接收并处理消息的客户端</li>
<li>消息: 应用程序之间传递的数据内容</li>
<li>消息模式: 在客户端中间传递消息的方式, JMS中定义了主题和队列两种模式<h4 id="队列模型"><a href="#队列模型" class="headerlink" title="队列模型"></a>队列模型</h4></li>
<li>客户端包括生产者和消费者</li>
<li>队列中的消息只能被一个消费者消费</li>
<li>消费者可以随时消费队列中的消息</li>
</ul>
<p><img src="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/quene.png" alt=""></p>
<h4 id="主题模式"><a href="#主题模式" class="headerlink" title="主题模式"></a>主题模式</h4><ul>
<li>客户端包括发布者和订阅者</li>
<li>主题中的消息被所有订阅者消费</li>
<li>消费者不能消费订阅之前就发送到主题中的内容</li>
</ul>
<p><img src="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/topic.png" alt=""></p>
<h4 id="JMS编码接口"><a href="#JMS编码接口" class="headerlink" title="JMS编码接口"></a>JMS编码接口</h4><ul>
<li>ConnectionFactory 用于创建连接到消息中间件的连接工厂</li>
<li>Connection 代表了应用程序和消息服务器之间的通信链路</li>
<li>Destination 指消息发布和接收的地点, 包括队列或主题</li>
<li>Session 表示一个单线程的上下文, 用于发送和接收消息</li>
<li>MessageProducer 由会话创建, 用于发送消息到目标</li>
<li>MessageConsumer 由会话创建, 用于接收发送到目标的消息</li>
<li>Message 是在生产者和消费者之间传递的对象. 消息头, 一组消息属性, 一个消息体</li>
</ul>
<p><img src="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/jms.png" alt=""></p>
<h3 id="ActiveMQ-的安装与使用"><a href="#ActiveMQ-的安装与使用" class="headerlink" title="ActiveMQ 的安装与使用"></a>ActiveMQ 的安装与使用</h3><h3 id="本地java版本必须要1-8及以上"><a href="#本地java版本必须要1-8及以上" class="headerlink" title="本地java版本必须要1.8及以上"></a>本地java版本必须要1.8及以上</h3><p>查询到console启动命令，启动后发现有错误日志输出：<br>./activemq console</p>
<p>默认后台端口8161</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 创建maven工程并添加activemq的相关依赖 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.jms.queue;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.jms.*;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 队列模型下的消息生产者</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppProducer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String url = <span class="string">"tcp://192.168.0.150:61616/"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String queueName = <span class="string">"queue-test"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// 1. 创建连接工厂</span></div><div class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(url);</div><div class="line"></div><div class="line">        <span class="comment">// 2. 创建Connection</span></div><div class="line">        Connection connection = connectionFactory.createConnection();</div><div class="line"></div><div class="line">        <span class="comment">// 3. 启动连接</span></div><div class="line">        connection.start();</div><div class="line"></div><div class="line">        <span class="comment">// 4. 创建会话(参数1: 是否在事务中处理, 参数2: 连接的应答模式)</span></div><div class="line">        Session session = connection.createSession(<span class="keyword">false</span>, Session.AUTO_ACKNOWLEDGE);</div><div class="line"></div><div class="line">        <span class="comment">// 5. 创建一个目标</span></div><div class="line">        Destination destination = session.createQueue(queueName);</div><div class="line"></div><div class="line">        <span class="comment">// 6. 创建一个生产者</span></div><div class="line">        MessageProducer producer = session.createProducer(destination);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) &#123;</div><div class="line">            <span class="comment">// 7. 创建消息</span></div><div class="line">            TextMessage textMessage = session.createTextMessage(<span class="string">"test"</span> + i);</div><div class="line"></div><div class="line">            <span class="comment">// 8. 发布消息</span></div><div class="line">            producer.send(textMessage);</div><div class="line"></div><div class="line">            System.out.println(<span class="string">" 发送消息"</span> + textMessage.getText());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 9. 关闭连接</span></div><div class="line">        connection.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.jms.queue;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.jms.*;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 队列模型下的消息消费者</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConsumer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String url = <span class="string">"tcp://192.168.0.150:61616/"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String queueName = <span class="string">"queue-test"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// 1. 创建连接工厂</span></div><div class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(url);</div><div class="line"></div><div class="line">        <span class="comment">// 2. 创建Connection</span></div><div class="line">        Connection connection = connectionFactory.createConnection();</div><div class="line"></div><div class="line">        <span class="comment">// 3. 启动连接</span></div><div class="line">        connection.start();</div><div class="line"></div><div class="line">        <span class="comment">// 4. 创建会话(参数1: 是否在事务中处理, 参数2: 连接的应答模式)</span></div><div class="line">        Session session = connection.createSession(<span class="keyword">false</span>, Session.AUTO_ACKNOWLEDGE);</div><div class="line"></div><div class="line">        <span class="comment">// 5. 创建一个目标</span></div><div class="line">        Destination destination = session.createQueue(queueName);</div><div class="line"></div><div class="line">        <span class="comment">// 6. 创建一个消费者, 并指定目的地</span></div><div class="line">        MessageConsumer consumer = session.createConsumer(destination);</div><div class="line"></div><div class="line">        <span class="comment">// 7. 创建一个监听器</span></div><div class="line">        consumer.setMessageListener(<span class="keyword">new</span> MessageListener() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">                TextMessage textMessage = (TextMessage) message;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    System.out.println(<span class="string">"接收到消息"</span> + textMessage.getText());</div><div class="line">                &#125; <span class="keyword">catch</span> (JMSException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="comment">// 9. 关闭连接 (因为监听消息是一个异步过程,所以当未消费到消息前,不要关闭连接)</span></div><div class="line">        <span class="comment">// connection.close();</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 主题模型下的消息发布者</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppProducer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String url = <span class="string">"tcp://192.168.0.150:61616/"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String topicName = <span class="string">"topic-test"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// 1. 创建连接工厂</span></div><div class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(url);</div><div class="line"></div><div class="line">        <span class="comment">// 2. 创建Connection</span></div><div class="line">        Connection connection = connectionFactory.createConnection();</div><div class="line"></div><div class="line">        <span class="comment">// 3. 启动连接</span></div><div class="line">        connection.start();</div><div class="line"></div><div class="line">        <span class="comment">// 4. 创建会话(参数1: 是否在事务中处理, 参数2: 连接的应答模式)</span></div><div class="line">        Session session = connection.createSession(<span class="keyword">false</span>, Session.AUTO_ACKNOWLEDGE);</div><div class="line"></div><div class="line">        <span class="comment">// 5. 创建一个目标</span></div><div class="line">        Destination destination = session.createTopic(topicName);</div><div class="line"></div><div class="line">        <span class="comment">// 6. 创建一个生产者</span></div><div class="line">        MessageProducer producer = session.createProducer(destination);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) &#123;</div><div class="line">            <span class="comment">// 7. 创建消息</span></div><div class="line">            TextMessage textMessage = session.createTextMessage(<span class="string">"test"</span> + i);</div><div class="line"></div><div class="line">            <span class="comment">// 8. 发布消息</span></div><div class="line">            producer.send(textMessage);</div><div class="line"></div><div class="line">            System.out.println(<span class="string">" 发送消息"</span> + textMessage.getText());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 9. 关闭连接</span></div><div class="line">        connection.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 主题模型下的消息订阅者</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConsumer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String url = <span class="string">"tcp://192.168.0.150:61616/"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String topicName = <span class="string">"topic-test"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JMSException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// 1. 创建连接工厂</span></div><div class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(url);</div><div class="line"></div><div class="line">        <span class="comment">// 2. 创建Connection</span></div><div class="line">        Connection connection = connectionFactory.createConnection();</div><div class="line"></div><div class="line">        <span class="comment">// 3. 启动连接</span></div><div class="line">        connection.start();</div><div class="line"></div><div class="line">        <span class="comment">// 4. 创建会话(参数1: 是否在事务中处理, 参数2: 连接的应答模式)</span></div><div class="line">        Session session = connection.createSession(<span class="keyword">false</span>, Session.AUTO_ACKNOWLEDGE);</div><div class="line"></div><div class="line">        <span class="comment">// 5. 创建一个目标</span></div><div class="line">        Destination destination = session.createTopic(topicName);</div><div class="line"></div><div class="line">        <span class="comment">// 6. 创建一个消费者, 并指定目的地</span></div><div class="line">        MessageConsumer consumer = session.createConsumer(destination);</div><div class="line"></div><div class="line">        <span class="comment">// 7. 创建一个监听器</span></div><div class="line">        consumer.setMessageListener(<span class="keyword">new</span> MessageListener() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">                TextMessage textMessage = (TextMessage) message;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    System.out.println(<span class="string">"接收到消息"</span> + textMessage.getText());</div><div class="line">                &#125; <span class="keyword">catch</span> (JMSException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="comment">// 9. 关闭连接 (因为监听消息是一个异步过程,所以当未消费到消息前,不要关闭连接)</span></div><div class="line">        <span class="comment">// connection.close();</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用Spring集成JMS连接ActiveMQ"><a href="#使用Spring集成JMS连接ActiveMQ" class="headerlink" title="使用Spring集成JMS连接ActiveMQ"></a>使用Spring集成JMS连接ActiveMQ</h3><ul>
<li>ConnectionFactory 用于管理连接的连接工厂<ul>
<li>Spring为我们提供的连接池</li>
<li>JmsTemplate每次发消息都会重新创建连接, 会话和productor</li>
<li>spring中提供了SingleConnectionFactory和CachingConnectionFactory</li>
</ul>
</li>
<li>JmsTemplate 用于发送和接收消息的模版类<ul>
<li>是spring提供的, 只需向spring容器内注册这个类可以使用JmsTemplate方便的操作jms</li>
<li>JmsTemplate类是线程安全的，可以在整个应用范围使用</li>
</ul>
</li>
<li>MessageListener 消息监听器<ul>
<li>实现一个onMessage方法, 该方法只接收一个Message参数</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 修改pom.xml --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jms<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 公共配置 --&gt;</span></div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></div><div class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 配置注解支持 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- ActiveMQ为我们提供的ConnectionFactory --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"targetConnectionFactory"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.ActiveMQConnectionFactory"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"brokerURL"</span> <span class="attr">value</span>=<span class="string">"tcp://192.168.0.150:61616"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- spring jms为我们提供的连接池 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.connection.SingleConnectionFactory"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"targetConnectionFactory"</span> <span class="attr">ref</span>=<span class="string">"targetConnectionFactory"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 一个队列目的地, 点对点的 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"queueDestination"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQQueue"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"queue"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 一个主题目的地, 发布订阅模式 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"topicDestination"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQTopic"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"topic"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 发布者spring配置  --&gt;</span></div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 导入公共配置 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"common.xml"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 配置消息监听器 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"consumerMessageListener"</span> <span class="attr">class</span>=<span class="string">"com.yhyecho.spring.jms.consumer.ConsumerMessageListener"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 配置消息监听容器 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsContainer"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.listener.DefaultMessageListenerContainer"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"connectionFactory"</span>/&gt;</span></div><div class="line">        <span class="comment">&lt;!--&lt;property name="destination" ref="queueDestination"/&gt;--&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 修改注入的目的地, 在队列和主题模式间切换 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"destination"</span> <span class="attr">ref</span>=<span class="string">"topicDestination"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageListener"</span> <span class="attr">ref</span>=<span class="string">"consumerMessageListener"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 订阅者spring配置  --&gt;</span></div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 导入公共配置 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"common.xml"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 配置jmsTemplate使用的连接池 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.core.JmsTemplate"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"connectionFactory"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 注入实现类 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.yhyecho.spring.jms.producer.ProducerServiceImpl"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.spring.jms.producer;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 消息发布者接口</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProducerService</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(String message)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.spring.jms.producer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.jms.core.JmsTemplate;</div><div class="line"><span class="keyword">import</span> org.springframework.jms.core.MessageCreator;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.annotation.Resource;</div><div class="line"><span class="keyword">import</span> javax.jms.*;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 消息发布者实现类</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerServiceImpl</span> <span class="keyword">implements</span> <span class="title">ProducerService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    JmsTemplate jmsTemplate;</div><div class="line"></div><div class="line">    <span class="comment">// 可能有多个目的地,使用@Resource注入</span></div><div class="line">    <span class="comment">// @Resource(name = "queueDestination") // 修改注入的目的地, 在队列和主题模式间切换</span></div><div class="line">    <span class="meta">@Resource</span>(name = <span class="string">"topicDestination"</span>)</div><div class="line">    Destination destination;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">final</span> String message)</span> </span>&#123;</div><div class="line">        <span class="comment">// 使用JmsTemplate发送消息</span></div><div class="line">        jmsTemplate.send(destination, <span class="keyword">new</span> MessageCreator() &#123;</div><div class="line">            <span class="comment">// 创建一个消息</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</div><div class="line">                TextMessage textMessage = session.createTextMessage(message);</div><div class="line">                <span class="keyword">return</span> textMessage;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"发送消息:"</span> + message);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.spring.jms.producer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 发布者发布</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppProducer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">        ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"producer.xml"</span>);</div><div class="line"></div><div class="line">        ProducerService service = context.getBean(ProducerService.class);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line">            service.sendMessage(<span class="string">"test"</span> + i);</div><div class="line">        &#125;</div><div class="line">        context.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.spring.jms.consumer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.jms.JMSException;</div><div class="line"><span class="keyword">import</span> javax.jms.Message;</div><div class="line"><span class="keyword">import</span> javax.jms.MessageListener;</div><div class="line"><span class="keyword">import</span> javax.jms.TextMessage;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 订阅者实现类</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerMessageListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">        TextMessage textMessage = (TextMessage) message;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(<span class="string">"接收消息:"</span> + textMessage.getText());</div><div class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yhyecho.spring.jms.consumer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</div><div class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 订阅者订阅</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConsumer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"consumer.xml"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="消息中间件-集群环境"><a href="#消息中间件-集群环境" class="headerlink" title="消息中间件(集群环境)"></a>消息中间件(集群环境)</h3><ul>
<li>ActiveMQ集群配置<blockquote>
<p>为什么要对消息中间件集群化部署</p>
</blockquote>
</li>
<li>实现高可用: 以排除单点故障引起的服务中断</li>
<li>实现负载均衡: 以提升效率为更多客户提供服务</li>
</ul>
<p>集群方式</p>
<ol>
<li>客户端集群: 让多个消费者消费同一个队列</li>
<li>Broker clusters: 多个Broker之间同步消息</li>
<li>Master Slave: 实现高可用</li>
</ol>
<p>客户端配置<br>ActiveMQ失效转移(failover)</p>
<ol>
<li>允许当其中一台消息服务器宕机时,客户端在传输层上重新连接到其他消息服务器<blockquote>
<p>语法: failover: (uri1,…,uriN)?transportOptions<br>transportOptions参数说明</p>
</blockquote>
</li>
</ol>
<ul>
<li>randomize默认为true, 表示在URI列表中选择URI连接时是否采用随机策略</li>
<li>initialReconnectDelay默认为10, 单位毫秒, 表示第一次尝试重连之间等待的时间</li>
<li>maxReconnectDelay 默认30000, 单位毫秒, 最长重连的时间间隔</li>
</ul>
<p>Broker Cluster 集群配置</p>
<p><img src="https://github-1255880316.cos.ap-beijing.myqcloud.com/Java/MQ/broker.png" alt=""><br>NetworkConnector(网络连接器)</p>
<blockquote>
<p>网络连接器主要用于配置ActiveMQ服务器与服务器之间的网络通讯方式, 用于服务器透传消息<br>网络连接器分为静态连接器和动态连接器<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 静态连接器 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">networkConnectors</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">networkConnector</span> <span class="attr">uri</span>=<span class="string">"static:(tcp://127.0.0.1:61617,tcp://127.0.0.1:61618)"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">networkConnectors</span>&gt;</span></div></pre></td></tr></table></figure></p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 动态连接器 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">networkConnectors</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">networkConnector</span> <span class="attr">uri</span>=<span class="string">"multicast://default"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">networkConnectors</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">transportConnectors</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">transportConnector</span> <span class="attr">uri</span>=<span class="string">"tcp://localhost:0"</span> <span class="attr">discoveryUri</span>=<span class="string">"multicast://default"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">transportConnectors</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li><p>消息中间件在企业系统中的最佳实践</p>
</li>
<li><p>其他常用消息中间件的使用</p>
</li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://www.yhyecho.com/2017/12/09/Java常用消息中间件入门/" data-title="Java常用消息中间件入门 | echo home" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2018/03/21/Redis/" title="">
  <strong>上一篇：</strong><br/>
  <span>
  (no title)</span>
</a>
</div>


<div class="next">
<a href="/2017/10/12/SpringBoot+Mybatis+小程序/"  title="SpringBoot+Mybatis+微信小程序">
 <strong>下一篇：</strong><br/> 
 <span>SpringBoot+Mybatis+微信小程序
</span>
</a>
</div>

</nav>

	


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么需要消息中间件"><span class="toc-number">1.</span> <span class="toc-text">为什么需要消息中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息中间件的作用"><span class="toc-number">2.</span> <span class="toc-text">消息中间件的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是中间件"><span class="toc-number">3.</span> <span class="toc-text">什么是中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是消息中间件"><span class="toc-number">4.</span> <span class="toc-text">什么是消息中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是JMS"><span class="toc-number">5.</span> <span class="toc-text">什么是JMS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是AMQP"><span class="toc-number">6.</span> <span class="toc-text">什么是AMQP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JMS和AMQP对比"><span class="toc-number">7.</span> <span class="toc-text">JMS和AMQP对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用消息中间件对比"><span class="toc-number">8.</span> <span class="toc-text">常用消息中间件对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#综合比较"><span class="toc-number">9.</span> <span class="toc-text">综合比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JMS规范"><span class="toc-number">10.</span> <span class="toc-text">JMS规范</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#队列模型"><span class="toc-number">10.1.</span> <span class="toc-text">队列模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#主题模式"><span class="toc-number">10.2.</span> <span class="toc-text">主题模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JMS编码接口"><span class="toc-number">10.3.</span> <span class="toc-text">JMS编码接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ActiveMQ-的安装与使用"><span class="toc-number">11.</span> <span class="toc-text">ActiveMQ 的安装与使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#本地java版本必须要1-8及以上"><span class="toc-number">12.</span> <span class="toc-text">本地java版本必须要1.8及以上</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用Spring集成JMS连接ActiveMQ"><span class="toc-number">13.</span> <span class="toc-text">使用Spring集成JMS连接ActiveMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息中间件-集群环境"><span class="toc-number">14.</span> <span class="toc-text">消息中间件(集群环境)</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="yhyecho" data-theme="medium"></div>
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>



</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<section class="info">
		<p> Hello, I&#39;m Echo  <br/>
			This is my blog, Welcome</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/yhyecho" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="yhyecho">yhyecho</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
